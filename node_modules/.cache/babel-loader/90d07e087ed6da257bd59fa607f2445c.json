{"ast":null,"code":"import { __spreadArrays } from \"tslib\";\nimport { uniq } from '@antv/util';\nimport { theme } from '../../adaptor/common';\nimport { deepAssign, findViewById, flow } from '../../utils';\nimport { addViewAnimation } from '../../utils/view';\nimport { polygon, edge } from '../../adaptor/geometries';\nimport { transformToViewsData } from './helper';\nimport { X_FIELD, Y_FIELD, COLOR_FIELD, EDGES_VIEW_ID, NODES_VIEW_ID } from './constant';\n/**\n * 默认配置项 处理\n * @param params\n */\n\nfunction defaultOptions(params) {\n  var options = params.options;\n  var _a = options.rawFields,\n      rawFields = _a === void 0 ? [] : _a;\n  return deepAssign({}, {\n    options: {\n      tooltip: {\n        fields: uniq(__spreadArrays(['name', 'source', 'target', 'value', 'isNode'], rawFields))\n      },\n      label: {\n        fields: uniq(__spreadArrays(['x', 'name'], rawFields))\n      }\n    }\n  }, params);\n}\n/**\n * geometry 处理\n * @param params\n */\n\n\nfunction geometry(params) {\n  var chart = params.chart,\n      options = params.options;\n  var color = options.color,\n      nodeStyle = options.nodeStyle,\n      edgeStyle = options.edgeStyle,\n      label = options.label,\n      tooltip = options.tooltip,\n      nodeState = options.nodeState,\n      edgeState = options.edgeState; // 1. 组件，优先设置，因为子 view 会继承配置\n\n  chart.legend(false);\n  chart.tooltip(tooltip);\n  chart.axis(false); // y 镜像一下，防止图形顺序和数据顺序反了\n\n  chart.coordinate().reflect('y'); // 2. node edge views\n  // @ts-ignore\n\n  var _a = transformToViewsData(options, chart.width, chart.height),\n      nodes = _a.nodes,\n      edges = _a.edges; // edge view\n\n\n  var edgeView = chart.createView({\n    id: EDGES_VIEW_ID\n  });\n  edgeView.data(edges);\n  edge({\n    chart: edgeView,\n    // @ts-ignore\n    options: {\n      xField: X_FIELD,\n      yField: Y_FIELD,\n      seriesField: COLOR_FIELD,\n      edge: {\n        color: color,\n        style: edgeStyle,\n        shape: 'arc'\n      },\n      tooltip: tooltip,\n      state: edgeState\n    }\n  });\n  var nodeView = chart.createView({\n    id: NODES_VIEW_ID\n  });\n  nodeView.data(nodes);\n  polygon({\n    chart: nodeView,\n    options: {\n      xField: X_FIELD,\n      yField: Y_FIELD,\n      seriesField: COLOR_FIELD,\n      polygon: {\n        color: color,\n        style: nodeStyle\n      },\n      label: label,\n      tooltip: tooltip,\n      state: nodeState\n    }\n  });\n  chart.interaction('element-active'); // scale\n\n  chart.scale({\n    x: {\n      sync: true,\n      nice: true,\n      min: 0,\n      max: 1,\n      minLimit: 0,\n      maxLimit: 1\n    },\n    y: {\n      sync: true,\n      nice: true,\n      min: 0,\n      max: 1,\n      minLimit: 0,\n      maxLimit: 1\n    },\n    name: {\n      sync: 'color',\n      type: 'cat'\n    }\n  });\n  return params;\n}\n/**\n * 动画\n * @param params\n */\n\n\nexport function animation(params) {\n  var chart = params.chart,\n      options = params.options;\n  var animation = options.animation;\n\n  var geometries = __spreadArrays(chart.views[0].geometries, chart.views[1].geometries);\n\n  addViewAnimation(chart, animation, geometries);\n  return params;\n}\n/**\n * 节点拖动\n * @param params\n */\n\nexport function nodeDraggable(params) {\n  var chart = params.chart,\n      options = params.options;\n  var nodeDraggable = options.nodeDraggable;\n  var DRAG_INTERACTION = 'sankey-node-draggable';\n\n  if (nodeDraggable) {\n    chart.interaction(DRAG_INTERACTION);\n  } else {\n    chart.removeInteraction(DRAG_INTERACTION);\n  }\n\n  return params;\n}\n/**\n * Interaction 配置\n * @param params\n */\n\nfunction interaction(params) {\n  var chart = params.chart,\n      options = params.options;\n  var _a = options.interactions,\n      interactions = _a === void 0 ? [] : _a;\n  var nodeInteractions = [].concat(interactions, options.nodeInteractions || []);\n  var edgeInteractions = [].concat(interactions, options.edgeInteractions || []);\n  var nodeView = findViewById(chart, NODES_VIEW_ID);\n  var edgeView = findViewById(chart, EDGES_VIEW_ID);\n  nodeInteractions.forEach(function (i) {\n    if ((i === null || i === void 0 ? void 0 : i.enable) === false) {\n      nodeView.removeInteraction(i.type);\n    } else {\n      nodeView.interaction(i.type, i.cfg || {});\n    }\n  });\n  edgeInteractions.forEach(function (i) {\n    if ((i === null || i === void 0 ? void 0 : i.enable) === false) {\n      edgeView.removeInteraction(i.type);\n    } else {\n      edgeView.interaction(i.type, i.cfg || {});\n    }\n  });\n  return params;\n}\n/**\n * 图适配器\n * @param chart\n * @param options\n */\n\n\nexport function adaptor(params) {\n  // flow 的方式处理所有的配置到 G2 API\n  return flow(defaultOptions, geometry, interaction, nodeDraggable, animation, theme // ... 其他的 adaptor flow\n  )(params);\n}","map":{"version":3,"sources":["../../../src/plots/sankey/adaptor.ts"],"names":[],"mappings":"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","sourcesContent":["import { uniq } from '@antv/util';\nimport { theme } from '../../adaptor/common';\nimport { Params } from '../../core/adaptor';\nimport { deepAssign, findViewById, flow } from '../../utils';\nimport { addViewAnimation } from '../../utils/view';\nimport { polygon, edge } from '../../adaptor/geometries';\nimport { transformToViewsData } from './helper';\nimport { SankeyOptions } from './types';\nimport { X_FIELD, Y_FIELD, COLOR_FIELD, EDGES_VIEW_ID, NODES_VIEW_ID } from './constant';\n\n/**\n * 默认配置项 处理\n * @param params\n */\nfunction defaultOptions(params: Params<SankeyOptions>): Params<SankeyOptions> {\n  const { options } = params;\n  const { rawFields = [] } = options;\n\n  return deepAssign(\n    {},\n    {\n      options: {\n        tooltip: {\n          fields: uniq(['name', 'source', 'target', 'value', 'isNode', ...rawFields]),\n        },\n        label: {\n          fields: uniq(['x', 'name', ...rawFields]),\n        },\n      },\n    },\n    params\n  );\n}\n\n/**\n * geometry 处理\n * @param params\n */\nfunction geometry(params: Params<SankeyOptions>): Params<SankeyOptions> {\n  const { chart, options } = params;\n  const { color, nodeStyle, edgeStyle, label, tooltip, nodeState, edgeState } = options;\n\n  // 1. 组件，优先设置，因为子 view 会继承配置\n  chart.legend(false);\n  chart.tooltip(tooltip);\n  chart.axis(false);\n  // y 镜像一下，防止图形顺序和数据顺序反了\n  chart.coordinate().reflect('y');\n\n  // 2. node edge views\n  // @ts-ignore\n  const { nodes, edges } = transformToViewsData(options, chart.width, chart.height);\n\n  // edge view\n  const edgeView = chart.createView({ id: EDGES_VIEW_ID });\n  edgeView.data(edges);\n\n  edge({\n    chart: edgeView,\n    // @ts-ignore\n    options: {\n      xField: X_FIELD,\n      yField: Y_FIELD,\n      seriesField: COLOR_FIELD,\n      edge: {\n        color,\n        style: edgeStyle,\n        shape: 'arc',\n      },\n      tooltip,\n      state: edgeState,\n    },\n  });\n\n  const nodeView = chart.createView({ id: NODES_VIEW_ID });\n  nodeView.data(nodes);\n\n  polygon({\n    chart: nodeView,\n    options: {\n      xField: X_FIELD,\n      yField: Y_FIELD,\n      seriesField: COLOR_FIELD,\n      polygon: {\n        color,\n        style: nodeStyle,\n      },\n      label,\n      tooltip,\n      state: nodeState,\n    },\n  });\n\n  chart.interaction('element-active');\n\n  // scale\n  chart.scale({\n    x: { sync: true, nice: true, min: 0, max: 1, minLimit: 0, maxLimit: 1 },\n    y: { sync: true, nice: true, min: 0, max: 1, minLimit: 0, maxLimit: 1 },\n    name: { sync: 'color', type: 'cat' },\n  });\n\n  return params;\n}\n\n/**\n * 动画\n * @param params\n */\nexport function animation(params: Params<SankeyOptions>): Params<SankeyOptions> {\n  const { chart, options } = params;\n  const { animation } = options;\n\n  const geometries = [...chart.views[0].geometries, ...chart.views[1].geometries];\n\n  addViewAnimation(chart, animation, geometries);\n\n  return params;\n}\n\n/**\n * 节点拖动\n * @param params\n */\nexport function nodeDraggable(params: Params<SankeyOptions>): Params<SankeyOptions> {\n  const { chart, options } = params;\n  const { nodeDraggable } = options;\n\n  const DRAG_INTERACTION = 'sankey-node-draggable';\n\n  if (nodeDraggable) {\n    chart.interaction(DRAG_INTERACTION);\n  } else {\n    chart.removeInteraction(DRAG_INTERACTION);\n  }\n\n  return params;\n}\n\n/**\n * Interaction 配置\n * @param params\n */\nfunction interaction(params: Params<SankeyOptions>): Params<SankeyOptions> {\n  const { chart, options } = params;\n  const { interactions = [] } = options;\n\n  const nodeInteractions = [].concat(interactions, options.nodeInteractions || []);\n  const edgeInteractions = [].concat(interactions, options.edgeInteractions || []);\n\n  const nodeView = findViewById(chart, NODES_VIEW_ID);\n  const edgeView = findViewById(chart, EDGES_VIEW_ID);\n\n  nodeInteractions.forEach((i) => {\n    if (i?.enable === false) {\n      nodeView.removeInteraction(i.type);\n    } else {\n      nodeView.interaction(i.type, i.cfg || {});\n    }\n  });\n\n  edgeInteractions.forEach((i) => {\n    if (i?.enable === false) {\n      edgeView.removeInteraction(i.type);\n    } else {\n      edgeView.interaction(i.type, i.cfg || {});\n    }\n  });\n\n  return params;\n}\n\n/**\n * 图适配器\n * @param chart\n * @param options\n */\nexport function adaptor(params: Params<SankeyOptions>) {\n  // flow 的方式处理所有的配置到 G2 API\n  return flow(\n    defaultOptions,\n    geometry,\n    interaction,\n    nodeDraggable,\n    animation,\n    theme\n    // ... 其他的 adaptor flow\n  )(params);\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}